pipeline {

  agent any 
  environment 
  {
		DOCKERHUB_CREDENTIALS=credentials('ram-dockerhub-login')
		TRIVY_CRITICAL_THRES=333
		NEXUS_REG_IP='10.182.0.16'
		NEXUS_REG_PORT=8082
		DOCK_IMG_NAME=${NEXUS_REG_IP}/appointme-admin-api:${BUILD_NUMBER}
		date_format = new Date().format('dd-MM-yy-HHmm')
			
  }
  stages 
  {
    stage("Create Docker image") 
      {
    
        withCredentials([usernamePassword(credentialsId: 'nexus-secret', passwordVariable: 'pass', usernameVariable: 'username')]) 
        {
      
              sh '''
                sudo docker build -t ${DOCK_IMG_NAME} .
                sudo docker login -u ${username} -p ${pass} ${NEXUS_REG_IP}:${NEXUS_REG_PORT}
                sudo docker push ${DOCK_IMG_NAME}
                
                '''
		     }

       }
  stage("Trivy Docker scan") 
  {
    steps 
    {
     sh '''
     
	      sudo trivy image ${DOCK_IMG_NAME} 2>/dev/null |grep "Total: [0-9]" 
	      TH=`sudo trivy image ${DOCK_IMG_NAME} 2>/dev/null |grep "Total: [0-9]" |cut -d ":" -f7|cut -d ")" -f1`
	      
        if [ -z "${TH}" ] || [ $TH -gt ${TRIVY_CRITICAL_THRES} ]
	      then   
	         echo "FAILED:Critical: "${TH} " has Crossed the Critical Threshold Limit of "${TRIVY_CRITICAL_THRES} !!!!!
		       exit 1
	      fi
	      
	      '''
 
     }
    }  
	     
   }
  }
