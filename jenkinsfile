pipeline {
  agent any 
  environment 
  {
		DOCKERHUB_CREDENTIALS=credentials('ram-dockerhub-login')
		TRIVY_CRITICAL_THRES=333
		DOCK_IMG_NAME="10.182.0.16/appointme-admin-api:ram-new"
		date_format = new Date().format('dd-MM-yy-HHmm')
			
  }
  stages 
  {
    stage("Create Docker image") 
      {
    
        withCredentials([usernamePassword(credentialsId: 'nexus-secret', passwordVariable: 'pass', usernameVariable: 'username')]) 
        {
      
              sh '''
                sudo docker build -t ${DOCK_IMG_NAME} .
                sudo docker login -u ${username} -p ${pass} ${NGINX_PROXY_URL}
                sudo docker push ${DOCK_IMG_NAME}
                
                '''
		     }

       }
  stage("Trivy Docker scan") 
  {
    steps 
    {
     sh '''
	      sudo trivy image ${DOCK_IMG_NAME} |sed -n '8,8p'
	      TH=`sudo trivy image ${DOCK_IMG_NAME} |sed -n '8,8p'|cut -d ":" -f7|cut -d ")" -f1`
	      
        if [ -z "${TH}" ] || [ $TH -gt ${TRIVY_CRITICAL_THRES} ]
	      then   
	         echo "FAILED:Critical: "${TH} " has Crossed the Critical Threshold Limit of "${TRIVY_CRITICAL_THRES} !!!!!
		       exit 1
	      fi
	      
	      '''
 
     }
    }  
	     
   }
  }
